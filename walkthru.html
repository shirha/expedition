<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checklist</title>
  <style>
    @font-face {
      font-family: "Lora"; 
      src: url("Lora-Regular.ttf");
    }
    body {
      background: url("screenshot.jpg") fixed no-repeat; background-size: cover; font-size: 18px;
      margin: 20px;
      /* 
      font-family: Arial, sans-serif;
      line-height: 1.6; 
      */
    }
    button {font-size: 18px;}
    #tt, table, pre {
      font-family: Lora;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .gy {
      display: inline-block;
      border-radius: 8px;
      padding: 0 8px;
      margin: 1px;
      font-style: normal;
      background-color: greenyellow;
    }
    div, table {
      display: inline-block;
      font-family: Lora;
/*      margin-left: 20px;*/
      border-collapse: collapse;
      border-spacing: 0px;
    }
    td {padding: 0;}
    img {
      height: 18px; 
      padding: 0 5px;
    }
    #tt {padding-left: 20px;}
</style>
</head>
<body>
  <pre id="mission-data">
<b>Xillup// Aanasusi</b>
  Fauna:9 Bountiful
  POI: Predators <img src='i/paws.png'/>
  <b><font color=green>Tip:</font></b> Scan Fauna:24, Flora:16, Chart Waypoints: 6
<div id=tt>Solar Mirror,1
Wiring Loom,4
Carbon,1130
Cobalt,220
Copper,1585
Crystal Sulphide,7
Deuterium,45
Di-hydrogen,80
Ferrite Dust,1235
Oxygen,175
Salt,100
Sodium,225</div>
  POI: Ms 5.4 In the Weeds
  ☐ Eliminate hazardous flora: 6
  POI: Ms 1.1 Alone in the Dark
  ☐ Locate your starship
  Reward: Advanced Mining Laser plans
  POI: Ms 1.2 From the Ashes
  ☐ Install Advanced Mining Laser
    Copper ×120
    Hermetic Seal ×1
    Metal Plating ×2
  Reward: Personal Refiner MK2 plans
  POI: Ms 1.3 Self-Reliance
  ☐ Install Personal Refiner MK2
    Condensed Carbon ×110
    Metal Plating ×2
    Oxygen ×140
  POI: Ms 2.3 Make Do and Mend
  ☐ Repair Multi-Tool and Starship
`  Refine: Silicate Powder ×1 + Di-hydrogen ×1 → Deuterium ×1
  <table><tr><td>Starship<tr>
    <td>  Launch Thruster(R) <td>Magnetised Ferrite ×50<tr>
    <td><td>Deuterium ×45<tr>
    <td>  Pulse Engine(R)<td>Hermetic Seal ×1<tr>
    <td><td>Metal Plating ×1<tr>
    <td>  Rusted Circiut<td>Copper ×95<tr>
    <td>  Hydraulic Damage<td>Condensed Carbon ×75<tr>
    <td>  Corroded Tanks<td>Ion Battery ×1<tr>
    <td><td>Oxygen ×35<tr>
    <td>  Hull Fracture<td>Magnetised Ferrite ×80</table>
  <table><tr><td>Multi-Tool<tr>
    <td>  Burnt-Out Terminal <td>Sodium Nitrate ×80<tr>
    <td>  Failed Resistor<td>Cobalt ×50<tr>
    <td>  Corrupt Module<td>Chromatic Metal ×60<tr>
    <td>  Loom Damage<td>Carbon Nanotube ×1<tr>
    <td><td>Hermetic Seal ×1</table>
  POI: Ms 5.2 Still They Hunger
  ☐ Purge Hungering Tendrils: 5
  POI: Ms 1.4 An Unlikely Escape
  ☐ Leave the planet
    Life Support Gel ×2
    Ion Battery ×8
    Creature Pellets ×2
    Ammunition ×3

<b>Xillup</b>
  POI: Ms 1.7 Worlds of Rock & Ice
  ☐ Destroy Asteroids: 30
`  Note: <b><font color=purple>Tritium</font></b> ×25 + Condensed Carbon ×20 → Antimatter ×1
  POI: Ms 1.5 Lights Out
  ☐ Visit the Space Station
  Reward: Signal Booster
  Hyperdrive plans
    Chromatic Metal ×125
    Microprocessor ×5

<b>Xillup // Orey XII</b>
  ☐ Find Heptaploid Wheat → Refined Flour
  Fauna:7 Frequent
  POI: Ms 3.2 Call of the Void
  ☐ Extract Radiant Shards: 1
  Reward: Warp Hypercore plans
  ☐ Mine: Activated Copper ×64, Atlantideum ×99
  POI: Ms 3.5 Abandonment +1.57, -160.00
  ☐ Restore a Crashed Ship
    Hermetic Seal ×1
    Metal Plating ×1
  Tip: Select Ms then use Signal Booster
`  Reward: Powerful Hyperdrive upgrade ×2

<b>Kasholman</b>
  POI: Ms 1.6 Independent People
  ☐ Warp to new system

<b>Kasholman // Xahilton Prime</b>
  Fauna:9 Generous
  ☐ POI: Ms 1.8 ℛ1 Observatory +27.52, +34.70
  POI: Ms 2.5 Stirring the Nest
  ☐ Steal Whispering Eggs: 9
  Reward: Nutrient Processor plans
    Metal Plating ×2
    Hermetic Seal ×1
    Sodium ×25
  Haz-Mat Gauntlet
    Sodium Nitrate ×20
    Chromatic Metal ×50   
  POI: Ms 5.5 By Bread Alone
  ☐ Cook some bread
`  Refine: Mordite ×30 → Faceum ×10
    Heptaploid Wheat → Refined Flour
    Faceum → Wild Yeast
    Refined Flour + Wild Yeast → Dough
    Dough → Bread
  POI: Ms 2.1 The Faintest Echo
  ☐ Visit a Holographic Comms Tower
  POI: Ms 2.4 Time On Your Feet
  ☐ Explore on foot: 6,500u
  Reward: Scatter Blaster
  Shell Greaser
    Magnetised Ferrite ×40
    Ionised Cobalt ×40
    Wiring Loom ×1
  POI: Ms 2.6 All That You Survey
  ☐ Summit a mountain of 1400u
  POI: Ms 4.2 Quantum Foam
  ☐ Earn nanites: 1600
  Refine: Vile Spawn, Flesh Rope & Larval Core

<b>Kasholman</b>
  POI: Ms 2.2 Amidst the Stars
  ☐ Interact with Prime Terminal in Anomaly
  Reward: Mind Ark plans
    Hypnotic Eye ×1
    Atlantideum ×99
    Activated Copper ×64
  ☐ Interact with Boundary Portal
  Reward: Specialized Warp plans
    Chromatic Metal ×250
    Wiring Loom ×3

<b>Zoongg // Ixst</b>
  Fauna:4 High
  ☐ POI: Ms 2.7 ℛ2 Trading Post -16.00, +98.14

<b>Ikedag-Faks XIV</b>
  POI: Ms 3.1 To Dream of Stars
  ☐ Pulse until Cloud Anomaly

<b>Ikedag-Faks XIV // Fincokla X26</b>
  Fauna:7 Bountiful
  ☐ POI: Ms 3.7 ℛ3 Observatory -10.07, +98.13

<b>Ikedag-Faks XIV // Shbu</b>
  Fauna:12 Copious
  POI: Ms 3.4 Bones to Dust
  ☐ Excavate ancient bones: 3

<b>Ikedag-Faks XIV // Acus Tau</b>
  Fauna:11 Rich
  POI: Ms 3.3 Life Reimagined
  ☐ Discover plants: 16
  POI: Ms 4.1 Signs to Nowhere
  ☐ Chart waypoints: 6
  Reward: Nautilon Chamber
    Metal Plating ×5
    Crystal Sulphide ×4
    Salt ×100
  High-Power Sonar
    Solar Mirror ×1
    Crystal Sulphide ×3
    Ferrite Dust ×50
  POI: Ms 4.3 Nameless History
  ☐ Scan for ancient ruins: 3
  POI: Ms 4.4 The Lure of the Deep
  ☐ Harvest Crystal Sulphide: 6
  POI: Ms 4.5 Fantoms Below
  ☐ Visit the site of a sunken freighter
  Reward: Emergency Signal Scanner
  POI: Ms 5.1 Not Alone
  ☐ Discover Creatures: 24

<b>Ublikul-Sobro</b>
  POI: Ms 4.7 To Dream of the Freedom
  ☐ Pulse until Cloud Anomaly
  POI: Ms 4.6 Dereliction
  ☐ Explore a derelict freighter
  <div class=gy>Note:</div> Jelly Fish<img src='i/jellyfish.png'> only enemy<i>!</i>

<b>Ublikul-Sobro // Apiaeinis lawa</b>
  Fauna:9 Abundant
  ☐ POI: Ms 4.8 ℛ4 Crashed Freighter +71.25, -10.36
  POI: Ms 5.3 Ghost in the Machine
  ☐ Scan for grave
  POI: Ms 5.6 A Still Small Voice
  ☐ Look a night sky: 60s

<b>Serkan-Run</b>
  POI: Ms 5.7 To Dream of Sleep
  ☐ Pulse until Cloud Anomaly

<b>Serkan-Run // Daun</b>
  Fauna: Lacking
  ☐ POI: Ms 5.8 ℛ5 Crashed Ship +42.13, +90.85

<b>Lederg-Akka <font color=red>⬤</font></b>
  Distance: 20 ly → Kasholman

<b>Lederg-Akka // Somerce VII</b>
  Fauna:4 Synthetic
  POI: Ms 3.6 It's Alive
  ☐ Discover robotic lifeforms: 2
  </pre>

  <button onClick="clearLocalStorage()">Clear</button>

  <script>
    const version = '13.1'; // Current version of the app
    const keywords = {'exotic':[], 'interceptor':[]};
    const conv = {
      "Ammunition": {"Ferrite Dust": 50},
      "Carbon Nanotube": {"Carbon": 50},
      "Chromatic Metal": {"Copper": 2},
      "Condensed Carbon": {"Carbon": 2},
      "Creature Pellets": {"Carbon": 60},
      "Hermetic Seal": {"Carbon": 60},
      "Ion Battery": {"Cobalt": 10, "Ferrite Dust": 5},
      "Ionised Cobalt": {"Cobalt": 2},
      "Life Support Gel": {"Carbon": 20, "Di-hydrogen": 40},
      "Magnetic Resonator": {"Ferrite Dust": 80, "Cobalt": 80},
      "Magnetised Ferrite": {"Ferrite Dust": 2},
      "Metal Plating": {"Ferrite Dust": 50},
      "Microprocessor": {"Carbon": 50, "Copper": 80},
      "Sodium Nitrate": {"Sodium": 2},
    };
    let tt, obj, dict = {}, title;

    function clearLocalStorage() {
      if(confirm("Are you sure?")){
        localStorage.clear();
        location.reload(); 
      }
    }

    function manageVersioning() {
      const storedVersion = localStorage.getItem('checkbox-0');
      if (storedVersion !== version) {
        // Clear localStorage if versions are different
        localStorage.clear();
        localStorage.setItem('checkbox-0', version); // Store the new version
      }
    }

    function parsePreContent() {
      const pre = document.getElementById('mission-data');
      const content = pre.innerHTML; // textContent;
      const lines = content.split('\n');
      let checkboxCount = 0, id, trace;
      const parsedContent = lines.map(line => {
        if (line.includes('☐')) {
          checkboxCount++;
          id = `checkbox-${checkboxCount}`;
          dict[id] = {};

          // track keywords in an Object (see Omega Redux)
          Object.keys(keywords).forEach(key => {
            if(line.toLowerCase().includes(key)){
              keywords[key].push(id);
            }
          });

          // Replace ☐ with an input checkbox element
          return line.replace('☐', `<input type="checkbox" id="${id}">`);
        }
        if (line.startsWith('\`')) {
          return line.slice(1);
        }

        const match = line.match(/(\w[\w\s-]+) ×(\d+)/);
        if (match) {
          const key = match[1]; // Object.keys(dict).find(k => line.includes(k));
          const value = parseInt(match[2], 10);
          if (id) {
            const dbg = id.match(/checkbox/);
            const temp = {3:"Advanced Mining Beam",4:"Personal Refiner MK2",5:"Repair Starship & Multi-tool",7:"Leave planet",13:"Restore crashed ship",9:"Hyperdrive",16:"Nutrient Processor, Haz-Mat Gauntlet",19:"Shell Greaser",22:"Mind Arc",23:"Cadmium Drive",29:"Nautilon Chamber, High-Power Sonar"}[checkboxCount];
            if (title != temp) {title = temp; console.log(title);}
            if (key in conv){
              Object.keys(conv[key]).map(k => {
                if (k in dict[id]) { trace = 'conv-1';
                  dict[id][k] += conv[key][k] * value;
                  if (dbg) 
                    console.log(`${id}, ${key.padEnd(18)}, ${String(value).padStart(3)}, ${k.padEnd(18)}, ${dict[id][k]}`);
                } else { trace = 'conv-0';
                  dict[id][k] = conv[key][k] * value;
                  if (dbg) 
                    console.log(`${id}, ${key.padEnd(18)}, ${String(value).padStart(3)}, ${k.padEnd(18)}, ${dict[id][k]}`);
                }
              });
            } else {
              if (key in dict[id]) { trace = 'dict-1';
                dict[id][key] += value; k = '';
                if (dbg) 
                  console.log(`${id}, ${key.padEnd(18)}, ${String(value).padStart(3)}, ${k.padEnd(18)}, ${dict[id][key]}`);
              } else { trace = 'dict-0';
                dict[id][key] = value; k = '';
                if (dbg) 
                  console.log(`${id}, ${key.padEnd(18)}, ${String(value).padStart(3)}, ${k.padEnd(18)}, ${dict[id][key]}`);
              }
            }
          }
        }
        return line; // Return the line unmodified if no checkbox found
      }).join('\n');

      pre.innerHTML = parsedContent;
      console.log('');

      // Restore checkbox states from localStorage
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        const id = checkbox.id;
        const savedState = localStorage.getItem(id);
        if (savedState !== null) {
          checkbox.checked = savedState === "true";

          let flag = false;
          Object.keys(dict[id]).forEach(key =>{
            if (key in obj && checkbox.checked) {
              flag = true;
              obj[key] += dict[id][key] * (checkbox.checked ? -1 : 1);
              console.log(`${id}, ${key.padEnd(18)}, ${String(dict[id][key]).padStart(3)}, ${obj[key]}`);
            }
          });
          if (flag) {
            document.getElementById('tt').textContent = Object.keys(obj).map(k => `${k},${obj[k]}`).join('\n');
          }
        }

        checkbox.addEventListener('change', () => {
          localStorage.setItem(id, checkbox.checked);

          let flag = false;
          Object.keys(dict[id]).forEach(key =>{
            if (key in obj) {
              flag = true;
              obj[key] += dict[id][key] * (checkbox.checked ? -1 : 1);
            }
          });
          if (flag) {
            document.getElementById('tt').textContent = Object.keys(obj).map(k => `${k},${obj[k]}`).join('\n');
          }

          // Loop through each keyword group
          Object.keys(keywords).forEach(key => {
            if (keywords[key].includes(id)) {
              // If this checkbox belongs to a keyword group, toggle all related checkboxes
              keywords[key].forEach(relatedId => {
                const relatedCheckbox = document.getElementById(relatedId);
                if (relatedCheckbox) {
                  relatedCheckbox.checked = checkbox.checked;
                  localStorage.setItem(relatedId, checkbox.checked); // Update localStorage for related checkboxes
                }
              });
            }
          });

        });
      });
    }

    function parseComponents() {
      return tt.textContent.split('\n') // Split the string into lines
        .map(line => line.trim()) // Trim leading/trailing spaces
        .map(line => line.split(',')) // Split each line into key-value pairs
        .reduce((acc, [key, value]) => {
          acc[key] = parseInt(value, 10); // Add to object, parse value as an integer
          return acc;
        }, {});
    }

    function updateComponents(checkbox, id) {
      let flag = false;
      Object.keys(dict[id]).forEach(key =>{
        if (key in obj && checkbox.checked) {
          flag = true;
          obj[key] += dict[id][key] * (checkbox.checked ? -1 : 1);
          // console.log(key, obj[key]);
        }
      });
      if (flag) {
        document.getElementById('tt').textContent = Object.keys(obj).map(k => `${k},${obj[k]}`).join('\n');
        console.log(tt);
      }
    }

    // On DOMContentLoaded, check version and parse content
    document.addEventListener('DOMContentLoaded', () => {
      tt = document.querySelector('#tt');
      obj = parseComponents();
      manageVersioning();
      parsePreContent();
    });
  </script>
</body>
</html>
